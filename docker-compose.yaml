services:
  open-webui:
    image: ghcr.io/open-webui/open-webui:main
    container_name: open-webui
    environment:
      - HOSTNAME=open-webui
      - OLLAMA_BASE_URL=http://172.28.0.3:11434
    ports:
      - "3000:8080"
    networks:
      rocm-network:
        ipv4_address: 172.28.0.2
    volumes:
      - ./open-webui:/app/backend/data
      - /etc/resolv.conf:/etc/resolv.conf:ro
    restart: always
    devices:
      - /dev/kfd:/dev/kfd
      - /dev/dri:/dev/dri
    group_add:
      - video
    security_opt:
      - "label=disable"
  ollama:
    image: getterup/ollama-rocm7.1:latest
    container_name: ollama
    ports:
      - "11434:11434"
    networks:
      rocm-network:
        ipv4_address: 172.28.0.3
    volumes:
      - ./ollama:/root/.ollama:Z
      - /etc/resolv.conf:/etc/resolv.conf:ro
    devices:
      - /dev/kfd:/dev/kfd
      - /dev/dri:/dev/dri
    group_add:
      - video
    environment:
      - HOSTNAME=ollama
      - OLLAMA_VULKAN=0
      - OLLAMA_DEBUG=2
      - OLLAMA_FLASH_ATTENTION=true
      - HSA_ENABLE_SDMA=0
      - OLLAMA_KEEP_ALIVE=-1
      - OLLAMA_MAX_LOADED_MODELS=1
      - OLLAMA_FLASH_ATTENTION=1
      - OLLAMA_GPU_OVERHEAD=0
      - OLLAMA_KEEP_ALIVE=1h
      - OLLAMA_LIBRARY_PATH="/usr/lib/ollama/rocm_v7"
      - ROCR_VISIBLE_DEVICES=0
    restart: unless-stopped
    cap_add:
      - SYS_PTRACE
    ipc: host
    security_opt:
      - seccomp=unconfined
      - label=disable
  stable-diffusion.cpp:
    image: getterup/stable-diffusion.cpp-rocm7.1:gfx1151
    container_name: stable-diffusion.cpp
    ports:
      - "7860:7860"
    networks:
        rocm-network:
          ipv4_address: 172.28.0.4
    volumes:
      - ./sd.cpp-webui/outputs/any2video:/sd-webui/outputs/any2video:Z
      - ./sd.cpp-webui/outputs/img2img:/sd-webui/outputs/img2img:Z
      - ./sd.cpp-webui/outputs/imgedit:/sd-webui/outputs/imgedit:Z
      - ./sd.cpp-webui/outputs/txt2img:/sd-webui/outputs/txt2img:Z
      - ./sd.cpp-webui/outputs/upscale:/sd-webui/outputs/upscale:Z
      - ./sd.cpp-webui/models/checkpoints:/sd-webui/models/checkpoints:Z
      - ./sd.cpp-webui/models/clip:/sd-webui/models/clip:Z
      - ./sd.cpp-webui/models/controlnet:/sd-webui/models/controlnet:Z
      - ./sd.cpp-webui/models/embeddings:/sd-webui/models/embeddings:Z
      - ./sd.cpp-webui/models/loras:/sd-webui/models/loras:Z
      - ./sd.cpp-webui/models/photomaker:/sd-webui/models/photomaker:Z
      - ./sd.cpp-webui/models/taesd:/sd-webui/models/taesd:Z
      - ./sd.cpp-webui/models/unet:/sd-webui/models/unet:Z
      - ./sd.cpp-webui/models/upscale_models:/sd-webui/models/upscale_models:Z
      - ./sd.cpp-webui/models/vae:/sd-webui/models/vae:Z
      - /etc/resolv.conf:/etc/resolv.conf:ro
    devices:
      - /dev/kfd:/dev/kfd
      - /dev/dri:/dev/dri
    group_add:
      - video
    #environment:
    #  - HSA_OVERRIDE_GFX_VERSION="11.5.1"
    restart: unless-stopped
    security_opt:
      - seccomp=unconfined
      - label=disable
  comfyui:
    image: getterup/comfyui:rocm7.1
    container_name: comfyui
    ports:
      - "8188:8188"
    networks:
      rocm-network:
        ipv4_address: 172.28.0.5
    volumes:
      - ./ComfyUI/models/audio_encoders:/app/ComfyUI/models/audio_encoders
      - ./ComfyUI/models/checkpoints:/app/ComfyUI/models/checkpoints
      - ./ComfyUI/models/clip:/app/ComfyUI/models/clip
      - ./ComfyUI/models/clip_vision:/app/ComfyUI/models/clip_vision
      - ./ComfyUI/models/controlnet:/app/ComfyUI/models/controlnet
      - ./ComfyUI/models/diffusers:/app/ComfyUI/models/diffusers
      - ./ComfyUI/models/diffusion_models:/app/ComfyUI/models/diffusion_models
      - ./ComfyUI/models/embeddings:/app/ComfyUI/models/embeddings
      - ./ComfyUI/models/gligen:/app/ComfyUI/models/gligen
      - ./ComfyUI/models/hypernetworks:/app/ComfyUI/models/hypernetworks
      - ./ComfyUI/models/latent_upscale_models:/app/ComfyUI/models/latent_upscale_models
      - ./ComfyUI/models/loras:/app/ComfyUI/models/loras
      - ./ComfyUI/models/model_patches:/app/ComfyUI/models/model_patches
      - ./ComfyUI/models/photomaker:/app/ComfyUI/models/photomaker
      - ./ComfyUI/models/style_models:/app/ComfyUI/models/style_models
      - ./ComfyUI/models/text_encoders:/app/ComfyUI/models/text_encoders
      - ./ComfyUI/models/unet:/app/ComfyUI/models/unet
      - ./ComfyUI/models/upscale_models:/app/ComfyUI/models/upscale_models
      - ./ComfyUI/models/vae:/app/ComfyUI/models/vae
      - ./ComfyUI/models/vae_approx:/app/ComfyUI/models/vae_approx
      - ./ComfyUI/output:/app/ComfyUI/output
      - ./ComfyUI/custom_nodes:/app/ComfyUI/custom_nodes
      - ./ComfyUI/input:/app/ComfyUI/input
      - ./ComfyUI/temp:/app/ComfyUI/temp
      - /etc/resolv.conf:/etc/resolv.conf:ro
    devices:
      - /dev/kfd:/dev/kfd
      - /dev/dri:/dev/dri
    group_add:
      - video
    environment:
      - HIP_VISIBLE_DEVICES=1
      - COMFYUI_ENABLE_ROCM=True
    restart: unless-stopped
    security_opt:
      - seccomp=unconfined
      - label=disable
networks:
  rocm-network:
    driver: bridge
    ipam:
      config:
        - subnet: 172.28.0.0/16
          gateway: 172.28.0.1