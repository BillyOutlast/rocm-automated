name: Daily ROCm Container Build (Pure Shell)

on:
  schedule:
    # Run daily at 02:00 UTC
    - cron: '0 2 * * *'
  workflow_dispatch: # Allow manual triggering
    inputs:
      push_images:
        description: 'Push images to registry'
        required: true
        default: 'true'
        type: boolean
      build_all:
        description: 'Build all variants'
        required: true
        default: 'true'
        type: boolean

env:
  REGISTRY: docker.io
  REGISTRY_USER: getterup
  
jobs:
  prepare:
    runs-on: ubuntu-latest
    outputs:
      date: ${{ steps.date.outputs.date }}
      sha_short: ${{ steps.vars.outputs.sha_short }}
      
    steps:
    - name: Manual checkout
      run: |
        echo "üîÑ Manually cloning repository..."
        git clone --depth=1 ${{ github.server_url }}/${{ github.repository }} /tmp/repo
        cd /tmp/repo
        if [ "${{ github.event_name }}" != "schedule" ]; then
          git fetch origin ${{ github.sha }}
          git checkout ${{ github.sha }}
        fi
        cp -r . ${{ github.workspace }}
      shell: bash
      
    - name: Get current date
      id: date
      run: |
        echo "date=$(date +'%Y-%m-%d')" >> $GITHUB_OUTPUT
      shell: bash
      
    - name: Set variables
      id: vars
      run: |
        echo "sha_short=$(echo ${GITHUB_SHA} | cut -c1-7)" >> $GITHUB_OUTPUT
      shell: bash

  build-base-images:
    runs-on: ubuntu-latest
    needs: prepare
    strategy:
      matrix:
        image:
          - name: comfyui-rocm7.1
            dockerfile: Dockerfile.comfyui-rocm7.1
            context: .
          - name: stable-diffusion.cpp-rocm7.1
            dockerfile: Dockerfile.stable-diffusion.cpp-rocm7.1
            context: .
    
    steps:
    - name: Manual checkout
      run: |
        echo "üîÑ Manually cloning repository..."
        git clone --depth=1 ${{ github.server_url }}/${{ github.repository }} /tmp/repo
        cd /tmp/repo
        if [ "${{ github.event_name }}" != "schedule" ]; then
          git fetch origin ${{ github.sha }}
          git checkout ${{ github.sha }}
        fi
        cp -r . ${{ github.workspace }}
      shell: bash
      
    - name: Set up Docker Buildx
      run: |
        echo "üê≥ Setting up Docker Buildx..."
        
        # Check if buildx is available
        if ! docker buildx version > /dev/null 2>&1; then
          echo "Installing Docker Buildx..."
          mkdir -p ~/.docker/cli-plugins
          BUILDX_VERSION="v0.12.1"
          wget -q -O ~/.docker/cli-plugins/docker-buildx \
            "https://github.com/docker/buildx/releases/download/${BUILDX_VERSION}/buildx-${BUILDX_VERSION}.linux-amd64"
          chmod +x ~/.docker/cli-plugins/docker-buildx
        fi
        
        # Create and use builder instance
        docker buildx create --name mybuilder --use --bootstrap || echo "Builder already exists"
        docker buildx inspect --bootstrap
      shell: bash
        
    - name: Log in to Docker Hub
      if: github.event_name == 'schedule' || (github.event_name == 'workflow_dispatch' && github.event.inputs.push_images == 'true')
      run: |
        echo "üîê Logging into Docker Hub..."
        echo "${{ secrets.DOCKER_PASSWORD }}" | docker login ${{ env.REGISTRY }} -u ${{ env.REGISTRY_USER }} --password-stdin
      shell: bash
        
    - name: Build and push Docker image
      run: |
        echo "üèóÔ∏è Building ${{ matrix.image.name }}..."
        
        IMAGE_NAME="${{ env.REGISTRY }}/${{ env.REGISTRY_USER }}/${{ matrix.image.name }}"
        TAGS="${IMAGE_NAME}:latest ${IMAGE_NAME}:${{ needs.prepare.outputs.date }} ${IMAGE_NAME}:${{ needs.prepare.outputs.sha_short }}"
        
        # Build the image
        BUILD_ARGS=""
        BUILD_ARGS="$BUILD_ARGS --build-arg BUILD_DATE=${{ needs.prepare.outputs.date }}"
        BUILD_ARGS="$BUILD_ARGS --build-arg VCS_REF=${{ needs.prepare.outputs.sha_short }}"
        
        PUSH_FLAG=""
        if [ "${{ github.event_name }}" == "schedule" ] || [ "${{ github.event.inputs.push_images }}" == "true" ]; then
          PUSH_FLAG="--push"
          echo "üì§ Will push images to registry"
        else
          PUSH_FLAG="--load"
          echo "üíæ Will load images locally only"
        fi
        
        docker buildx build \
          --context ${{ matrix.image.context }} \
          --file Dockerfiles/${{ matrix.image.dockerfile }} \
          --platform linux/amd64 \
          $BUILD_ARGS \
          $(for tag in $TAGS; do echo "--tag $tag"; done) \
          $PUSH_FLAG \
          .
          
        echo "‚úÖ Build completed for ${{ matrix.image.name }}"
      shell: bash
          
  build-stable-diffusion-variants:
    runs-on: ubuntu-latest
    needs: prepare
    if: github.event_name == 'schedule' || (github.event_name == 'workflow_dispatch' && github.event.inputs.build_all == 'true')
    strategy:
      matrix:
        gfx_arch:
          - gfx1150  # RDNA 3.5 (Ryzen AI 9 HX 370)
          - gfx1151  # RDNA 3.5 (Strix Point/Ryzen AI Max+ 365)
          - gfx1200  # RDNA 4 (RX 9070 XT)
          - gfx1100  # RDNA 3 (RX 7900 XTX/XT)
          - gfx1101  # RDNA 3 (RX 7800 XT/7700 XT)
          - gfx1030  # RDNA 2 (RX 6000 series)
          - gfx1201  # RDNA 4 (RX 9060 XT/ RX 9070/XT)
    
    steps:
    - name: Manual checkout
      run: |
        echo "üîÑ Manually cloning repository..."
        git clone --depth=1 ${{ github.server_url }}/${{ github.repository }} /tmp/repo
        cd /tmp/repo
        if [ "${{ github.event_name }}" != "schedule" ]; then
          git fetch origin ${{ github.sha }}
          git checkout ${{ github.sha }}
        fi
        cp -r . ${{ github.workspace }}
      shell: bash
      
    - name: Set up Docker Buildx
      run: |
        echo "üê≥ Setting up Docker Buildx for GPU variant ${{ matrix.gfx_arch }}..."
        
        # Check if buildx is available
        if ! docker buildx version > /dev/null 2>&1; then
          echo "Installing Docker Buildx..."
          mkdir -p ~/.docker/cli-plugins
          BUILDX_VERSION="v0.12.1"
          wget -q -O ~/.docker/cli-plugins/docker-buildx \
            "https://github.com/docker/buildx/releases/download/${BUILDX_VERSION}/buildx-${BUILDX_VERSION}.linux-amd64"
          chmod +x ~/.docker/cli-plugins/docker-buildx
        fi
        
        # Create and use builder instance
        docker buildx create --name mybuilder-${{ matrix.gfx_arch }} --use --bootstrap || echo "Builder already exists"
        docker buildx inspect --bootstrap
      shell: bash
        
    - name: Log in to Docker Hub
      if: github.event_name == 'schedule' || (github.event_name == 'workflow_dispatch' && github.event.inputs.push_images == 'true')
      run: |
        echo "üîê Logging into Docker Hub for ${{ matrix.gfx_arch }}..."
        echo "${{ secrets.DOCKER_PASSWORD }}" | docker login ${{ env.REGISTRY }} -u ${{ env.REGISTRY_USER }} --password-stdin
      shell: bash
        
    - name: Build and push GPU variant image
      run: |
        echo "üèóÔ∏è Building GPU variant for ${{ matrix.gfx_arch }}..."
        
        IMAGE_NAME="${{ env.REGISTRY }}/${{ env.REGISTRY_USER }}/stable-diffusion-cpp-${{ matrix.gfx_arch }}"
        TAGS="${IMAGE_NAME}:latest ${IMAGE_NAME}:${{ needs.prepare.outputs.date }} ${IMAGE_NAME}:${{ needs.prepare.outputs.sha_short }}"
        
        # Build the GPU-specific image
        BUILD_ARGS=""
        BUILD_ARGS="$BUILD_ARGS --build-arg GFX_ARCH=${{ matrix.gfx_arch }}"
        BUILD_ARGS="$BUILD_ARGS --build-arg BUILD_DATE=${{ needs.prepare.outputs.date }}"
        BUILD_ARGS="$BUILD_ARGS --build-arg VCS_REF=${{ needs.prepare.outputs.sha_short }}"
        
        PUSH_FLAG=""
        if [ "${{ github.event_name }}" == "schedule" ] || [ "${{ github.event.inputs.push_images }}" == "true" ]; then
          PUSH_FLAG="--push"
          echo "üì§ Will push ${{ matrix.gfx_arch }} variant to registry"
        else
          PUSH_FLAG="--load"
          echo "üíæ Will load ${{ matrix.gfx_arch }} variant locally only"
        fi
        
        docker buildx build \
          --context . \
          --file Dockerfiles/Dockerfile.stable-diffusion.cpp-rocm7.1 \
          --platform linux/amd64 \
          $BUILD_ARGS \
          $(for tag in $TAGS; do echo "--tag $tag"; done) \
          $PUSH_FLAG \
          .
          
        echo "‚úÖ Build completed for ${{ matrix.gfx_arch }} variant"
      shell: bash

  test-compose:
    runs-on: ubuntu-latest
    needs: [prepare, build-base-images]
    if: github.event_name == 'schedule' || github.event_name == 'workflow_dispatch'
    
    steps:
    - name: Manual checkout
      run: |
        echo "üîÑ Manually cloning repository..."
        git clone --depth=1 ${{ github.server_url }}/${{ github.repository }} /tmp/repo
        cd /tmp/repo
        if [ "${{ github.event_name }}" != "schedule" ]; then
          git fetch origin ${{ github.sha }}
          git checkout ${{ github.sha }}
        fi
        cp -r . ${{ github.workspace }}
      shell: bash
        
    - name: Create test directories
      run: |
        echo "üìÅ Creating test directories..."
        mkdir -p User-Directories/open-webui
        mkdir -p User-Directories/ollama
        mkdir -p User-Directories/comfyui
        echo "‚úÖ Test directories created"
      shell: bash
        
    - name: Install Docker Compose
      run: |
        echo "üê≥ Installing Docker Compose..."
        
        if ! command -v docker-compose &> /dev/null; then
          echo "Installing docker-compose..."
          sudo curl -L "https://github.com/docker/compose/releases/latest/download/docker-compose-$(uname -s)-$(uname -m)" \
            -o /usr/local/bin/docker-compose
          sudo chmod +x /usr/local/bin/docker-compose
        fi
        
        docker-compose --version
      shell: bash
        
    - name: Test docker-compose configuration
      run: |
        echo "üìã Testing Docker Compose configuration..."
        
        # Validate compose file
        docker-compose config --quiet
        echo "‚úÖ Docker Compose configuration is valid"
        
        # Test services definition
        docker-compose config --services
        echo "‚úÖ Services configuration verified"
      shell: bash
        
    - name: Test image availability
      run: |
        echo "üìã Testing image availability..."
        
        # Check if images exist in registry (without pulling)
        IMAGES=(
          "${{ env.REGISTRY }}/${{ env.REGISTRY_USER }}/comfyui-rocm7.1:latest"
          "${{ env.REGISTRY }}/${{ env.REGISTRY_USER }}/stable-diffusion.cpp-rocm7.1:latest"
        )
        
        for image in "${IMAGES[@]}"; do
          echo "Checking $image..."
          if docker manifest inspect "$image" >/dev/null 2>&1; then
            echo "‚úÖ $image is available"
          else
            echo "‚ö†Ô∏è $image may not be available yet"
          fi
        done
        
        echo "‚úÖ Image availability check completed"
      shell: bash

  notify:
    runs-on: ubuntu-latest
    needs: [prepare, build-base-images, build-stable-diffusion-variants, test-compose]
    if: always() && (github.event_name == 'schedule')
    
    steps:
    - name: Build summary
      run: |
        echo "üìä Daily Build Summary - ${{ needs.prepare.outputs.date }}"
        echo "=================================="
        echo ""
        echo "üîß Job Results:"
        echo "- Prepare: ${{ needs.prepare.result }}"
        echo "- Base Images: ${{ needs.build-base-images.result }}"
        echo "- GPU Variants: ${{ needs.build-stable-diffusion-variants.result }}"
        echo "- Compose Test: ${{ needs.test-compose.result }}"
        echo ""
        
        SUCCESS_COUNT=0
        TOTAL_COUNT=4
        
        [ "${{ needs.prepare.result }}" == "success" ] && SUCCESS_COUNT=$((SUCCESS_COUNT + 1))
        [ "${{ needs.build-base-images.result }}" == "success" ] && SUCCESS_COUNT=$((SUCCESS_COUNT + 1))
        [ "${{ needs.build-stable-diffusion-variants.result }}" == "success" ] && SUCCESS_COUNT=$((SUCCESS_COUNT + 1))
        [ "${{ needs.test-compose.result }}" == "success" ] && SUCCESS_COUNT=$((SUCCESS_COUNT + 1))
        
        echo "üìà Success Rate: $SUCCESS_COUNT/$TOTAL_COUNT jobs completed successfully"
        
        if [ "$SUCCESS_COUNT" -eq "$TOTAL_COUNT" ]; then
          echo "üéâ All builds completed successfully!"
          echo "üê≥ Images pushed to ${{ env.REGISTRY }}/${{ env.REGISTRY_USER }}/"
          echo "üìã Docker Compose configuration validated"
          echo "üèóÔ∏è Built images:"
          echo "  - comfyui-rocm7.1:${{ needs.prepare.outputs.date }}"
          echo "  - stable-diffusion.cpp-rocm7.1:${{ needs.prepare.outputs.date }}"
          echo "  - 7 GPU-specific variants"
        elif [ "$SUCCESS_COUNT" -gt 0 ]; then
          echo "‚ö†Ô∏è Partial success - $SUCCESS_COUNT out of $TOTAL_COUNT jobs completed"
          echo "Please check the individual job logs for details"
        else
          echo "‚ùå All jobs failed - please check the logs"
          exit 1
        fi
      shell: bash

  cleanup:
    runs-on: ubuntu-latest
    needs: [build-base-images, build-stable-diffusion-variants]
    if: always()
    
    steps:
    - name: Clean up Docker resources
      run: |
        echo "üßπ Cleaning up Docker resources..."
        
        # Clean up build cache and unused images
        docker system prune -f --volumes || echo "‚ö†Ô∏è Docker system prune failed"
        docker builder prune -f || echo "‚ö†Ô∏è Builder prune failed"
        
        # Clean up buildx builders
        docker buildx ls | grep -E "mybuilder|gitea-builder" | awk '{print $1}' | while read builder; do
          echo "Removing builder: $builder"
          docker buildx rm "$builder" || echo "‚ö†Ô∏è Failed to remove builder $builder"
        done
        
        echo "‚úÖ Cleanup completed"
      shell: bash