# ComfyUI with ROCm support for different AMD GPU architectures
FROM rocm/dev-ubuntu-24.04:7.1-complete AS default
RUN apt-get update \
    && apt-get install -y ca-certificates libvulkan1 \
    && apt-get clean \
    && rm -rf /var/lib/apt/lists/*

# Copy ComfyUI repository and pre-built virtual environment
WORKDIR /app
COPY ComfyUI /app/ComfyUI

# Copy the appropriate virtual environment based on GPU architecture
# The venv should be created by running create-venv.sh on the host
COPY ${GPU_ARCH} /app/ComfyUI/venv

# Set working directory to ComfyUI
WORKDIR /app/ComfyUI

# Set environment to use the virtual environment and add ROCm runtime settings
ENV PATH="/app/ComfyUI/venv/bin:$PATH" \
    VIRTUAL_ENV="/app/ComfyUI/venv" \
    AMD_SERIALIZE_KERNEL=3 \
    HIP_VISIBLE_DEVICES=0 \
    PYTORCH_ROCM_ARCH="${GPU_ARCH}" \
    HSA_OVERRIDE_GFX_VERSION="${GPU_ARCH}" \
    TORCH_USE_HIP_DSA=1

# Expose default ComfyUI port
EXPOSE 8188

# Set the default command to run ComfyUI with ROCm optimizations
CMD ["python", "main.py", "--listen", "0.0.0.0", "--port", "8188", "--force-fp16"] 
