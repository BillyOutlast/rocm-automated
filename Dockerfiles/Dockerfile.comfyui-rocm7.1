# ComfyUI with ROCm support for different AMD GPU architectures
FROM docker.io/getterup/fedora-rocm7.1:latest

# Build arguments for different PyTorch versions
ARG GPU_ARCH="rocm7.1"

# ROCm environment variables
ENV ROCM_PATH=/opt/rocm \
    HIP_PATH=/opt/rocm \
    HIP_CLANG_PATH=/opt/rocm/llvm/bin \
    HIP_DEVICE_LIB_PATH=/opt/rocm/amdgcn/bitcode \
    PATH=/opt/rocm/bin:/opt/rocm/llvm/bin:$PATH

# Install system dependencies and ROCm
RUN dnf update -y && \
    dnf install -y git python3 python3-pip && \
    dnf clean all

# Set up library paths and ROCm environment
ENV LD_LIBRARY_PATH=/opt/rocm/lib:/opt/rocm/lib64:$LD_LIBRARY_PATH \
    HIP_VISIBLE_DEVICES=0 \
    AMD_SERIALIZE_KERNEL=3 \
    PYTORCH_ROCM_ARCH="${GPU_ARCH}" \
    HSA_OVERRIDE_GFX_VERSION="${GPU_ARCH}" \
    TORCH_USE_HIP_DSA=1

# Copy ComfyUI repository and pre-built virtual environment
WORKDIR /app
COPY ComfyUI /app/ComfyUI

# Copy the appropriate virtual environment based on GPU architecture
# The venv should be created by running create-venv.sh on the host
COPY ${GPU_ARCH} /app/ComfyUI/venv

# Set working directory to ComfyUI
WORKDIR /app/ComfyUI

# Set environment to use the virtual environment and add ROCm runtime settings
ENV PATH="/app/ComfyUI/venv/bin:$PATH" \
    VIRTUAL_ENV="/app/ComfyUI/venv" \
    AMD_SERIALIZE_KERNEL=3 \
    HIP_VISIBLE_DEVICES=0 \
    PYTORCH_ROCM_ARCH="${GPU_ARCH}" \
    HSA_OVERRIDE_GFX_VERSION="${GPU_ARCH}" \
    TORCH_USE_HIP_DSA=1

# Expose default ComfyUI port
EXPOSE 8188

# Set the default command to run ComfyUI with ROCm optimizations
CMD ["python", "main.py", "--listen", "0.0.0.0", "--port", "8188", "--force-fp16"] 
