FROM docker.io/getterup/fedora-rocm7.1:latest
# vim: filetype=dockerfile


# Build configuration - paths matching build-ollama-binary.sh
ARG BUILD_OUTPUT_DIR="./ollama-build/ollama-build-output"

# Copy from mounted output to standard system locations for runtime
RUN cp ${BUILD_OUTPUT_DIR}/bin/ollama /usr/bin/ollama \
    && cp -r ${BUILD_OUTPUT_DIR}/lib/ollama /usr/lib/ollama \
    && chmod +x /usr/bin/ollama


# ROCm environment variables for runtime
ENV ROCM_PATH=/opt/rocm \
    HIP_PATH=/opt/rocm \
    HIP_CLANG_PATH=/opt/rocm/llvm/bin \
    HIP_DEVICE_LIB_PATH=/opt/rocm/amdgcn/bitcode \
    PATH=/opt/rocm/bin:/opt/rocm/llvm/bin:$PATH

# Set up library paths and environment
ENV LD_LIBRARY_PATH=/opt/rocm/lib:/usr/lib/ollama:/usr/lib/ollama/rocm:$LD_LIBRARY_PATH 

# Expose port
EXPOSE 11434

ENTRYPOINT ["/usr/bin/ollama", "serve"]