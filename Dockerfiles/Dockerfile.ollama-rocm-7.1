# Multi-stage Dockerfile to build Ollama from rjmalagon/ollama-linux-amd-apu
# Optimized for AMD APUs with ROCm 7.1 support

# Build stage
FROM registry.fedoraproject.org/fedora:43 AS builder

# Add ROCm 7.1 repository
RUN <<'EOF'
tee /etc/yum.repos.d/rocm.repo <<REPO
[ROCm-7.1]
name=ROCm7.1
baseurl=https://repo.radeon.com/rocm/el9/7.1/main
enabled=1
priority=50
gpgcheck=1
gpgkey=https://repo.radeon.com/rocm/rocm.gpg.key
REPO
EOF

# Install build dependencies
RUN dnf -y --nodocs --setopt=install_weak_deps=False \
    --exclude='*sdk*' --exclude='*samples*' --exclude='*-doc*' --exclude='*-docs*' \
    install \
      make gcc gcc-c++ cmake ninja-build \
      git-core curl wget ca-certificates \
      lld clang clang-devel compiler-rt \
      rocm-llvm rocm-device-libs hip-runtime-amd hip-devel \
      rocblas rocblas-devel hipblas hipblas-devel \
      rocm-cmake libomp-devel libomp \
      rocminfo radeontop \
      libcurl-devel \
 && dnf clean all && rm -rf /var/cache/dnf/*

# Set ROCm environment variables
ENV ROCM_PATH=/opt/rocm \
    HIP_PATH=/opt/rocm \
    HSA_PATH=/opt/rocm/hsa \
    HIP_CLANG_PATH=/opt/rocm/llvm/bin \
    HIP_DEVICE_LIB_PATH=/opt/rocm/amdgcn/bitcode \
    PATH=/opt/rocm/bin:/opt/rocm/llvm/bin:$PATH

# Build arguments
ARG FLAVOR=rocm
ARG PARALLEL=8
ARG CMAKEVERSION=3.31.2

# Install CMake
RUN curl -fsSL https://github.com/Kitware/CMake/releases/download/v${CMAKEVERSION}/cmake-${CMAKEVERSION}-linux-$(uname -m).tar.gz | tar xz -C /usr/local --strip-components 1

# Clone the AMD APU optimized Ollama repository
WORKDIR /ollama-src
RUN git clone -b apu-optimizer https://github.com/rjmalagon/ollama-linux-amd-apu.git . \
    && git config --global --add safe.directory /ollama-src

# Build environment setup
ENV LDFLAGS=-s
ENV PATH=/opt/rocm/hcc/bin:/opt/rocm/hip/bin:/opt/rocm/bin:/opt/rocm/hcc/bin:$PATH

# Build llama.cpp with ROCm support for AMD GPUs
RUN --mount=type=cache,target=/root/.ccache \
    cmake --preset 'ROCm 7' \
        -DOLLAMA_RUNNER_DIR="rocm_v7" \
        -DCMAKE_C_COMPILER=clang \
        -DCMAKE_CXX_COMPILER=clang++ \
        -DSD_HIPBLAS=ON \
        -DGGML_VULKAN=OFF \
        -DAMDGPU_TARGETS="gfx1100,gfx1151" \
        -DROCM_PATH=/opt/rocm \
        -DHIP_PATH=/opt/rocm \
        && cmake --build --parallel ${PARALLEL} --preset 'ROCm 7' \
        && cmake --install build --component HIP --strip --parallel ${PARALLEL}

# Clean up ROCm libraries (remove unsupported architectures)
RUN rm -f dist/lib/ollama/rocm/rocblas/library/*gfx90[06]*

# Install Go and build Ollama binary
RUN curl -fsSL https://golang.org/dl/go$(awk '/^go/ { print $2 }' go.mod).linux-$(case $(uname -m) in x86_64) echo amd64 ;; aarch64) echo arm64 ;; esac).tar.gz | tar xz -C /usr/local
ENV PATH=/usr/local/go/bin:$PATH

# Download Go dependencies
RUN go mod download

# Build Ollama binary
ARG GOFLAGS="'-ldflags=-w -s'"
ENV CGO_ENABLED=1
RUN --mount=type=cache,target=/root/.cache/go-build \
    go build -trimpath -buildmode=pie -buildvcs=false -o /usr/bin/ollama .

# Runtime stage
FROM registry.fedoraproject.org/fedora:43

# Add ROCm repository for runtime
RUN <<'EOF'
tee /etc/yum.repos.d/rocm.repo <<REPO
[ROCm-7.1]
name=ROCm7.1
baseurl=https://repo.radeon.com/rocm/el9/7.1/main
enabled=1
priority=50
gpgcheck=1
gpgkey=https://repo.radeon.com/rocm/rocm.gpg.key
REPO
EOF

# Install runtime dependencies
RUN dnf -y --nodocs --setopt=install_weak_deps=False \
    --exclude='*sdk*' --exclude='*samples*' --exclude='*-doc*' --exclude='*-docs*' \
    install \
      ca-certificates \
      rocm-runtime rocm-device-libs hip-runtime-amd \
      rocblas hipblas rocminfo \
 && dnf clean all && rm -rf /var/cache/dnf/*

# Copy built binaries and libraries from builder stage
COPY --from=builder /usr/bin/ollama /usr/bin/ollama
COPY --from=builder /ollama-src/dist/lib/ollama /usr/lib/ollama

# Set executable permissions and create rocm_v7 symlink
RUN chmod +x /usr/bin/ollama \
    && ln -sf /usr/lib/ollama/rocm /usr/lib/ollama/rocm_v7 \
    && echo "Testing ROCm library loading..." \
    && ldd /usr/bin/ollama | grep -E "(rocm|hip)" || echo "No ROCm libraries linked to ollama binary"

# ROCm environment variables for runtime
ENV ROCM_PATH=/opt/rocm \
    HIP_PATH=/opt/rocm \
    HSA_PATH=/opt/rocm/hsa \
    HIP_CLANG_PATH=/opt/rocm/llvm/bin \
    HIP_DEVICE_LIB_PATH=/opt/rocm/amdgcn/bitcode \
    HSA_ENABLE_SDMA=0 \
    HSA_OVERRIDE_GFX_VERSION=11.0.0 \
    GPU_MAX_ALLOC_PERCENT=100 \
    GPU_MAX_HEAP_SIZE=100 \
    OLLAMA_FLASH_ATTENTION=true \
    OLLAMA_KV_CACHE_TYPE=q8_0 \
    OLLAMA_DEBUG=2 \
    PATH=/opt/rocm/bin:/opt/rocm/llvm/bin:$PATH

# Set library paths
ENV LD_LIBRARY_PATH=/opt/rocm/lib:/opt/rocm/lib64:/usr/lib/ollama:/usr/lib/ollama/rocm:/usr/lib/ollama/rocm_v7:$LD_LIBRARY_PATH

# Expose Ollama port
ENV OLLAMA_HOST=0.0.0.0:11434
EXPOSE 11434

# Entry point
ENTRYPOINT ["/usr/bin/ollama", "serve"]

# vim: filetype=dockerfile